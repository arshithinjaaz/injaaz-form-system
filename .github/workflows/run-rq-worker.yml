# .github/workflows/run-rq-worker.yml (replace relevant steps)
name: Run RQ worker on-demand

on:
  workflow_dispatch: {}

jobs:
  run-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 30   # increase if jobs may take longer

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # install full project deps so worker can run job code
          pip install -r requirements.txt

      - name: Verify Redis connectivity (debug)
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          python - <<'PY'
          import os, sys
          try:
              import redis
              url = os.environ.get('REDIS_URL', '')
              print("REDIS_URL:", url[:60] + ("..." if len(url)>60 else ""))
              if not url:
                  print("No REDIS_URL provided")
                  sys.exit(2)
              r = redis.from_url(url, socket_connect_timeout=5, decode_responses=True)
              print("Trying PING ...")
              ok = r.ping()
              print("PING response:", ok)
              sys.exit(0 if ok else 3)
          except Exception as e:
              print("REDIS connectivity check FAILED:", repr(e))
              sys.exit(4)
          PY

      - name: Run rq worker in burst (process queued jobs then exit)
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          CLOUDINARY_UPLOAD_PRESET: ${{ secrets.CLOUDINARY_UPLOAD_PRESET }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
        run: |
          echo "Starting rq worker in --burst mode (will process jobs and exit)."
          # verbose (-v) makes RQ print more info; --burst makes worker exit when queue is empty
          rq worker default -u "$REDIS_URL" --burst -v
          echo "rq worker process finished."
