# url=https://github.com/<owner>/<repo>/blob/main/.github/workflows/run-rq-worker.yml
name: Run RQ worker on-demand

on:
  workflow_dispatch: {}

jobs:
  run-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ensure python can import from the repo workspace root
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install project package (editable) if possible
        # If your repo has pyproject.toml or setup.py this installs the package so imports work.
        run: |
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            pip install -e .
          else
            echo "No pyproject.toml or setup.py found; skipped pip install -e ."
          fi

      - name: Verify Redis connectivity (debug)
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          python - <<'PY'
import os, traceback
try:
    import redis
    url = os.environ.get('REDIS_URL','')
    print("REDIS_URL (head):", url[:70] + ("..." if len(url)>70 else ""))
    if not url:
        raise SystemExit("No REDIS_URL provided")
    r = redis.from_url(url, socket_connect_timeout=7, decode_responses=True)
    print("Trying PING ...")
    ok = r.ping()
    print("PING response:", ok)
except Exception:
    print("REDIS connectivity check FAILED")
    traceback.print_exc()
    raise
PY

      - name: Run rq worker in burst (process queued jobs then exit)
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          CLOUDINARY_UPLOAD_PRESET: ${{ secrets.CLOUDINARY_UPLOAD_PRESET }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
        run: |
          echo "Starting rq worker in --burst mode (verbose)"
          python -m rq worker default -u "$REDIS_URL" --burst -v
          echo "rq worker finished"
