name: Run RQ worker on-demand

on:
  workflow_dispatch: {}

jobs:
  run-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install redis rq

      - name: Run RQ worker for a limited time
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          echo "Starting rq worker (will run for up to 5 minutes)..."
          # Start the worker in background and record its PID
          rq worker default --url "$REDIS_URL" &
          WORKER_PID=$!
          echo "Worker started with PID $WORKER_PID"
          # Let it run for N seconds (adjust below). 300s = 5 minutes.
          sleep 300
          echo "Stopping worker (PID $WORKER_PID)"
          kill "$WORKER_PID" || true
          echo "Worker stopped"
