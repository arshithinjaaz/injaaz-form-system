[1mdiff --git a/Dockerfile b/Dockerfile[m
[1mindex c8e70e3..338831f 100644[m
[1m--- a/Dockerfile[m
[1m+++ b/Dockerfile[m
[36m@@ -1,17 +1,31 @@[m
[31m-# Start with a clean, stable version of Python[m
[32m+[m[32m# Use official slim Python image[m
 FROM python:3.11-slim[m
 [m
[31m-# Set the working directory inside the cloud package[m
[32m+[m[32mENV PYTHONDONTWRITEBYTECODE=1 \[m
[32m+[m[32m    PYTHONUNBUFFERED=1[m
[32m+[m
 WORKDIR /app[m
 [m
[31m-# Install the ingredients (Flask, gunicorn, Pillow)[m
[32m+[m[32m# Install runtime system deps needed by Pillow/reportlab[m
[32m+[m[32mRUN apt-get update && apt-get install -y --no-install-recommends \[m
[32m+[m[32m    build-essential \[m
[32m+[m[32m    libjpeg-dev \[m
[32m+[m[32m    zlib1g-dev \[m
[32m+[m[32m    && rm -rf /var/lib/apt/lists/*[m
[32m+[m
[32m+[m[32m# Install Python dependencies from requirements.txt[m
 COPY requirements.txt .[m
[31m-# Ensure we install Pillow now[m
 RUN pip install --no-cache-dir -r requirements.txt[m
 [m
[31m-# Copy all your files (Injaaz.py, templates, static, etc.) into the package[m
[31m-COPY . . [m
[32m+[m[32m# Copy the app code[m
[32m+[m[32mCOPY . .[m
[32m+[m
[32m+[m[32m# Create folder for generated files and non-root user[m
[32m+[m[32mRUN mkdir -p /app/generated /app/generated/images && \[m
[32m+[m[32m    useradd --create-home appuser && chown -R appuser /app[m
[32m+[m[32mUSER appuser[m
[32m+[m
[32m+[m[32mEXPOSE 5000[m
 [m
[31m-# Tell the cloud how to run your app, using gunicorn to start Injaaz.py[m
[31m-# CRITICAL FIX: Explicitly set --workers 1 to reserve maximum memory for the PDF generation process.[m
[31m-CMD exec gunicorn --timeout 60 --workers 1 --threads 4 Injaaz:app -b 0.0.0.0:$PORT[m
\ No newline at end of file[m
[32m+[m[32m# Default command for web service[m
[32m+[m[32mCMD ["gunicorn", "--timeout", "120", "--workers", "1", "--threads", "4", "wsgi:app", "-b", "0.0.0.0:5000"][m
\ No newline at end of file[m
[1mdiff --git a/Injaaz.py b/Injaaz.py[m
[1mindex 8fd1ee0..f855b0e 100644[m
[1m--- a/Injaaz.py[m
[1m+++ b/Injaaz.py[m
[36m@@ -1,63 +1,34 @@[m
[31m-# Injaaz.py[m
[31m-[m
[31m-import os[m
[31m-from flask import Flask, send_from_directory, abort, render_template[m
[31m-[m
[31m-# 1. Import the Blueprint object for Form 1 (Site Visit Report)[m
[31m-# Ensure 'module_site_visit/routes.py' is completely clean of errors![m
[31m-from module_site_visit.routes import site_visit_bp[m
[31m-[m
[31m-# 2. Import the Blueprint object for Form 2 (The new Site Assessment Report)[m
[31m-from module_site_assessment.routes import site_assessment_bp[m
[31m-[m
[31m-# 3. Import the Blueprint object for Form 3 (New Site Civil Report)[m
[31m-from module_site_civil.routes import site_civil_bp[m
[31m-[m
[31m-# --- CONFIGURATION ---[m
[31m-BASE_DIR = os.path.dirname(os.path.abspath(__file__))[m
[31m-GENERATED_DIR_NAME = "generated"[m
[31m-GENERATED_DIR = os.path.join(BASE_DIR, GENERATED_DIR_NAME)[m
[31m-[m
[31m-# Initialize Flask App[m
[31m-app = Flask(__name__)[m
[31m-[m
[31m-# Ensure required directories exist at startup[m
[31m-os.makedirs(GENERATED_DIR, exist_ok=True)[m
[31m-os.makedirs(os.path.join(GENERATED_DIR, "images"), exist_ok=True)[m
[31m-[m
[31m-# --- Blueprint Registration ---[m
[31m-# Register Blueprint for Form 1 (MEP/HVAC)[m
[31m-app.register_blueprint(site_visit_bp, url_prefix='/site-visit')[m
[31m-[m
[31m-# Register Blueprint for Form 2 (Site Assessment)[m
[31m-app.register_blueprint(site_assessment_bp, url_prefix='/site-assessment')[m
[31m-[m
[31m-# Register Blueprint for Form 3 (New Site Civil Report)[m
[31m-app.register_blueprint(site_civil_bp, url_prefix='/site-civil')[m
[31m-[m
[31m-# --- Root Route Renders Dashboard ---[m
[31m-@app.route('/')[m
[31m-def index():[m
[31m-    """Renders the dashboard page with links to available forms."""[m
[31m-    # This renders the updated dashboard.html[m
[31m-    return render_template('dashboard.html')[m
[31m-[m
[31m-# --- Shared Route: File Download ---[m
[31m-@app.route(f'/{GENERATED_DIR_NAME}/<path:filename>')[m
[31m-def download_generated(filename):[m
[31m-    """Allows direct download of files from the 'generated' directory."""[m
[31m-[m
[31m-    global GENERATED_DIR[m
[31m-[m
[31m-    full_path = os.path.join(GENERATED_DIR, filename)[m
[31m-[m
[31m-    if not os.path.exists(full_path):[m
[31m-        print(f"File not found at: {full_path}")[m
[31m-        abort(404)[m
[31m-[m
[31m-    return send_from_directory(GENERATED_DIR, filename, as_attachment=True)[m
[31m-[m
[31m-# --- Run Application ---[m
[31m-if __name__ == '__main__':[m
[31m-    # When deploying to Render, the host will be set by the environment[m
[31m-    app.run(debug=True, host='0.0.0.0')[m
\ No newline at end of file[m
[32m+[m[32mfrom flask import Flask, jsonify, send_from_directory[m
[32m+[m[32mfrom pathlib import Path[m
[32m+[m[32mimport config[m
[32m+[m[32mfrom cloudinary_utils import init_cloudinary[m
[32m+[m
[32m+[m[32mdef create_app():[m
[32m+[m[32m    app = Flask(__name__)[m
[32m+[m[32m    app.config["SECRET_KEY"] = config.SECRET_KEY[m
[32m+[m
[32m+[m[32m    init_cloudinary(config)[m
[32m+[m
[32m+[m[32m    @app.route("/health")[m
[32m+[m[32m    def health():[m
[32m+[m[32m        return jsonify({"status": "ok"})[m
[32m+[m
[32m+[m[32m    @app.route("/download/<path:filename>")[m
[32m+[m[32m    def download(filename):[m
[32m+[m[32m        from werkzeug.utils import secure_filename[m
[32m+[m[32m        fn = secure_filename(filename)[m
[32m+[m[32m        generated_dir = Path(config.GENERATED_DIR)[m
[32m+[m[32m        file_path = (generated_dir / fn).resolve()[m
[32m+[m[32m        try:[m
[32m+[m[32m            file_path.relative_to(generated_dir.resolve())[m
[32m+[m[32m        except Exception:[m
[32m+[m[32m            return "Invalid filename", 400[m
[32m+[m[32m        if not file_path.exists():[m
[32m+[m[32m            return "Not found", 404[m
[32m+[m[32m        return send_from_directory(str(generated_dir), fn, as_attachment=True)[m
[32m+[m
[32m+[m[32m    return app[m
[32m+[m
[32m+[m[32mif __name__ == "__main__":[m
[32m+[m[32m    app = create_app()[m
[32m+[m[32m    app.run(host="0.0.0.0", port=5000, debug=True)[m
\ No newline at end of file[m
[1mdiff --git a/config.py b/config.py[m
[1mindex 58a8be2..c72091d 100644[m
[1m--- a/config.py[m
[1m+++ b/config.py[m
[36m@@ -1,12 +1,20 @@[m
[31m-# config.py[m
[31m-[m
 import os[m
[32m+[m[32mfrom pathlib import Path[m
[32m+[m
[32m+[m[32mBASE_DIR = Path(__file__).resolve().parent[m
[32m+[m
[32m+[m[32mGENERATED_DIR = Path(os.getenv("GENERATED_DIR", BASE_DIR / "generated"))[m
[32m+[m
[32m+[m[32mSECRET_KEY = os.getenv("SECRET_KEY", "dev-secret")[m
[32m+[m[32mFLASK_ENV = os.getenv("FLASK_ENV", "production")[m
 [m
[31m-BASE_DIR = os.path.dirname(os.path.abspath(__file__))[m
[32m+[m[32mREDIS_URL = os.getenv("REDIS_URL", "redis://localhost:6379/0")[m
[32m+[m[32mRQ_QUEUE = os.getenv("RQ_QUEUE", "default")[m
 [m
[31m-# --- GLOBAL PATH CONFIGURATION ---[m
[31m-GENERATED_DIR_NAME = "generated"[m
[31m-GENERATED_DIR = os.path.join(BASE_DIR, GENERATED_DIR_NAME)[m
[32m+[m[32mCLOUDINARY_CLOUD_NAME = os.getenv("CLOUDINARY_CLOUD_NAME", "")[m
[32m+[m[32mCLOUDINARY_API_KEY = os.getenv("CLOUDINARY_API_KEY", "")[m
[32m+[m[32mCLOUDINARY_API_SECRET = os.getenv("CLOUDINARY_API_SECRET", "")[m
 [m
[31m-# Path for data (Used by the form module to read JSON)[m
[31m-DROPDOWN_DATA_PATH = os.path.join(BASE_DIR, 'data', 'dropdown_data.json')[m
\ No newline at end of file[m
[32m+[m[32mGUNICORN_WORKERS = int(os.getenv("GUNICORN_WORKERS", "1"))[m
[32m+[m[32mGUNICORN_THREADS = int(os.getenv("GUNICORN_THREADS", "4"))[m
[32m+[m[32mGUNICORN_TIMEOUT = int(os.getenv("GUNICORN_TIMEOUT", "120"))[m
\ No newline at end of file[m
[1mdiff --git a/requirements.txt b/requirements.txt[m
[1mindex 4d25f7a..5092edc 100644[m
[1m--- a/requirements.txt[m
[1m+++ b/requirements.txt[m
[36m@@ -1,12 +1,13 @@[m
[31m-Flask[m
[31m-gunicorn[m
[31m-openpyxl[m
[31m-reportlab[m
[31m-pandas[m
[31m-Pillow[m
[31m-boto3[m
[31m-requests[m
[31m-cloudinary[m
[31m-xlsxwriter[m
[31m-redis>=4.5.5[m
[31m-rq[m
\ No newline at end of file[m
[32m+[m[32mFlask==2.2.5[m
[32m+[m[32mgunicorn==20.1.0[m
[32m+[m[32mopenpyxl==3.1.2[m
[32m+[m[32mreportlab==3.6.14[m
[32m+[m[32mpandas==2.1.3[m
[32m+[m[32mPillow==9.5.0[m
[32m+[m[32mboto3==1.26.99[m
[32m+[m[32mrequests==2.31.0[m
[32m+[m[32mcloudinary==1.29.0[m
[32m+[m[32mXlsxWriter==3.1.2[m
[32m+[m[32mredis==4.5.5[m
[32m+[m[32mrq==1.13.0[m
[32m+[m[32mpython-dotenv==1.0.0[m
\ No newline at end of file[m
